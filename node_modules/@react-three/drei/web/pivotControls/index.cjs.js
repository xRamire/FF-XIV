"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),r=require("react"),t=require("@react-three/fiber"),i=require("meshline"),o=require("./AxisArrow.cjs.js"),n=require("./PlaneSlider.cjs.js"),a=require("./AxisRotator.cjs.js"),c=require("./context.cjs.js");function s(e){if(e&&e.__esModule)return e;var r=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var i=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,i.get?i:{enumerable:!0,get:function(){return e[t]}})}})),r.default=e,Object.freeze(r)}require("../../core/Line.cjs.js"),require("@babel/runtime/helpers/extends"),require("three-stdlib"),require("../Html.cjs.js"),require("react-dom/client"),require("lodash.clamp");var l=s(e),u=s(r);const d=new l.Vector3,x=new l.Vector3,p=new l.Vector3,m=(e,r,t,i=1)=>{const o=d.set(e.x/t.width*2-1,-e.y/t.height*2+1,i);return o.unproject(r),o},y=(e,r,t,i)=>{const o=((e,r,t)=>{const i=t.width/2,o=t.height/2;r.updateMatrixWorld(!1);const n=e.project(r);return n.x=n.x*i+i,n.y=-n.y*o+o,n})(p.copy(e),t,i);let n=0;for(let a=0;a<2;++a){const c=x.copy(o).setComponent(a,o.getComponent(a)+r),s=m(c,t,i,c.z);n=Math.max(n,e.distanceTo(s))}return n},f=new l.Matrix4,w=new l.Matrix4,h=new l.Matrix4,g=new l.Matrix4,v=new l.Matrix4,M=new l.Matrix4,j=new l.Matrix4,b=new l.Matrix4,E=new l.Box3,A=new l.Box3,q=new l.Vector3,V=new l.Vector3,R=new l.Vector3,S=new l.Vector3,L=new l.Vector3(1,0,0),P=new l.Vector3(0,1,0),C=new l.Vector3(0,0,1),D=u.forwardRef((({matrix:e,onDragStart:r,onDrag:s,onDragEnd:d,autoTransform:x=!0,anchor:p,disableAxes:m=!1,disableSliders:D=!1,disableRotations:W=!1,activeAxes:O=[!0,!0,!0],offset:B=[0,0,0],rotation:T=[0,0,0],scale:z=1,lineWidth:_=4,fixed:k=!1,translationLimits:F,rotationLimits:H,depthTest:I=!0,axisColors:U=["#ff2060","#20df80","#2080ff"],hoveredColor:G="#ffff40",displayValues:J=!0,annotationsClass:K,opacity:N=1,visible:Q=!0,userData:X,children:Y},Z)=>{t.extend({MeshLine:i.MeshLine,MeshLineMaterial:i.MeshLineMaterial});const $=t.useThree((e=>e.invalidate)),ee=u.useRef(null),re=u.useRef(null),te=u.useRef(null),ie=u.useRef(null),oe=u.useRef([0,0,0]);u.useLayoutEffect((()=>{p&&(ie.current.updateWorldMatrix(!0,!0),g.copy(ie.current.matrixWorld).invert(),E.makeEmpty(),ie.current.traverse((e=>{e.geometry&&(e.geometry.boundingBox||e.geometry.computeBoundingBox(),M.copy(e.matrixWorld).premultiply(g),A.copy(e.geometry.boundingBox),A.applyMatrix4(M),E.union(A))})),q.copy(E.max).add(E.min).multiplyScalar(.5),V.copy(E.max).sub(E.min).multiplyScalar(.5),R.copy(V).multiply(new l.Vector3(...p)).add(q),S.set(...B).add(R),te.current.position.copy(S),$())}));const ne=u.useMemo((()=>({onDragStart:e=>{f.copy(re.current.matrix),w.copy(re.current.matrixWorld),r&&r(e),$()},onDrag:e=>{h.copy(ee.current.matrixWorld),g.copy(h).invert(),v.copy(w).premultiply(e),M.copy(v).premultiply(g),j.copy(f).invert(),b.copy(M).multiply(j),x&&re.current.matrix.copy(M),s&&s(M,b,v,e),$()},onDragEnd:()=>{d&&d(),$()},translation:oe,translationLimits:F,rotationLimits:H,axisColors:U,hoveredColor:G,opacity:N,scale:z,lineWidth:_,fixed:k,displayValues:J,depthTest:I,userData:X,annotationsClass:K})),[r,s,d,oe,F,H,I,z,_,k,...U,G,N,J,X,x,K]),ae=new l.Vector3;return t.useFrame((e=>{if(k){const o=y(te.current.getWorldPosition(ae),z,e.camera,e.size);var r,t,i;if(te.current)(null==(r=te.current)?void 0:r.scale.x)===o&&(null==(t=te.current)?void 0:t.scale.y)===o&&(null==(i=te.current)?void 0:i.scale.z)===o||(te.current.scale.setScalar(o),e.invalidate())}})),u.useImperativeHandle(Z,(()=>re.current),[]),u.createElement(c.context.Provider,{value:ne},u.createElement("group",{ref:ee},u.createElement("group",{ref:re,matrix:e,matrixAutoUpdate:!1},u.createElement("group",{visible:Q,ref:te,position:B,rotation:T},!m&&O[0]&&u.createElement(o.AxisArrow,{axis:0,direction:L}),!m&&O[1]&&u.createElement(o.AxisArrow,{axis:1,direction:P}),!m&&O[2]&&u.createElement(o.AxisArrow,{axis:2,direction:C}),!D&&O[0]&&O[1]&&u.createElement(n.PlaneSlider,{axis:2,dir1:L,dir2:P}),!D&&O[0]&&O[2]&&u.createElement(n.PlaneSlider,{axis:1,dir1:C,dir2:L}),!D&&O[2]&&O[1]&&u.createElement(n.PlaneSlider,{axis:0,dir1:P,dir2:C}),!W&&O[0]&&O[1]&&u.createElement(a.AxisRotator,{axis:2,dir1:L,dir2:P}),!W&&O[0]&&O[2]&&u.createElement(a.AxisRotator,{axis:1,dir1:C,dir2:L}),!W&&O[2]&&O[1]&&u.createElement(a.AxisRotator,{axis:0,dir1:P,dir2:C})),u.createElement("group",{ref:ie},Y))))}));exports.PivotControls=D,exports.calculateScaleFactor=y;
